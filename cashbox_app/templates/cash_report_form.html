{% block content %}
<h2>Cash Report Form</h2>
<form method="post">
    {% csrf_token %}
    <input type="hidden" name="next" value="{{ next }}">
    <div>
        <label>Сотрудник смены:</label>
        {{ form.author }}
    </div>
    <div>
        <label>Адрес:</label>
        {{ form.id_address }}
    </div>

    <div>
        <label>Тип операции:</label>
        {{ form.cas_register }}
    </div>

    <table>
        <thead>
            <tr>
                <th></th>
                <th>Скупка</th>
                <th>Ломбард</th>
                <th>Техника</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Остаток денежных средств в начале:</td>
                <td>{{ form.cash_balance_beginning_buying_up }}</td>
                <td>{{ form.cash_balance_beginning_pawnshop }}</td>
                <td>{{ form.cash_balance_beginning_technique }}</td>
            </tr>
            <tr>
                <td>Внесено в кассу:</td>
                <td>{{ form.introduced_buying_up }}</td>
                <td>{{ form.introduced_pawnshop }}</td>
                <td>{{ form.introduced_technique }}</td>
            </tr>
            <tr>
                <td>Средства от процентов с залога, возврата выданных займов:</td>
                <td>{{ form.interest_return_buying_up }}</td>
                <td>{{ form.interest_return_pawnshop }}</td>
                <td>{{ form.interest_return_technique }}</td>
            </tr>
            <tr>
                <td>Выдано займов:</td>
                <td>{{ form.loans_issued_buying_up }}</td>
                <td>{{ form.loans_issued_pawnshop }}</td>
                <td>{{ form.loans_issued_technique }}</td>
            </tr>
            <tr>
                <td>На хоз. нужды, оплату труда:</td>
                <td>{{ form.used_farming_buying_up }}</td>
                <td>{{ form.used_farming_pawnshop }}</td>
                <td>{{ form.used_farming_technique }}</td>
            </tr>
            <tr>
                <td>Выемка денежных средств руководителем:</td>
                <td>{{ form.boss_took_it_buying_up }}</td>
                <td>{{ form.boss_took_it_pawnshop }}</td>
                <td>{{ form.boss_took_it_technique }}</td>
            </tr>
            <tr>
                <td>Остаток на конец дня:</td>
                <td id="cash_register_end_buying_up">{{ form.cash_register_end_buying_up }}</td>
                <td id="cash_register_end_pawnshop">{{ form.cash_register_end_pawnshop }}</td>
                <td id="cash_register_end_technique">{{ form.cash_register_end_technique }}</td>
            </tr>
        </tbody>
    </table>

    <div>
        <label>Статус:</label>
        {{ form.status }}
    </div>

    <button type="submit">Отправить</button>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Function to calculate cash register end
    function calculateCashRegisterEnd(type) {
        var beginningBalance = parseFloat(document.querySelector(`input[name="${type}_cash_balance_beginning"]`).value);
        var introduced = parseFloat(document.querySelector(`input[name="${type}_introduced"]`).value || 0);
        var interestReturn = parseFloat(document.querySelector(`input[name="${type}_interest_return"]`).value || 0);
        var loansIssued = parseFloat(document.querySelector(`input[name="${type}_loans_issued"]`).value || 0);
        var usedFarming = parseFloat(document.querySelector(`input[name="${type}_used_farming"]`).value || 0);
        var bossTookIt = parseFloat(document.querySelector(`input[name="${type}_boss_took_it"]`).value || 0);

        var result = beginningBalance + introduced + interestReturn - loansIssued - usedFarming - bossTookIt;
        document.getElementById(`cash_register_end_${type}`).value = result.toFixed(2);
    }

    // Calculate initial values
    ['buying_up', 'pawnshop', 'technique'].forEach(type => {
        document.querySelectorAll(`input[name^="${type}"]`).forEach(input => {
            input.addEventListener('input', function() {
                calculateCashRegisterEnd(type);
            });
        });
    });

    // Add event listener to cas_register
    document.querySelector('input[name="cas_register"]').addEventListener('change', function() {
        const selectedType = this.value;
        ['cash_balance_beginning', 'introduced', 'interest_return', 'loans_issued', 'used_farming', 'boss_took_it', 'cash_register_end'].forEach(field => {
            document.querySelectorAll(`input[name^="${selectedType}_${field}"]`).forEach(input => {
                input.disabled = false;
            });
        });
        ['cash_balance_beginning', 'introduced', 'interest_return', 'loans_issued', 'used_farming', 'boss_took_it', 'cash_register_end'].forEach(field => {
            document.querySelectorAll(`input[name^="${'buying_up' if selectedType === 'Скупка' else 'pawnshop' if selectedType === 'Ломбард' else 'technique'}_${field}"]`).forEach(input => {
                input.disabled = true;
            });
        });
    });
});
</script>

{% endblock %}
